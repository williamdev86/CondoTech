<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Editar Cliente</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="/clientes" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Voltar
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Informações do Cliente</h5>
    </div>
    <div class="card-body">
        <form action="/clientes/atualizar/<%= cliente.id %>" method="POST">
            <div class="row">
                <!-- Dados Pessoais -->
                <div class="col-12 mb-3">
                    <h6 class="text-muted">Dados Pessoais</h6>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="nome" class="form-label">Nome Completo*</label>
                    <input type="text" class="form-control" id="nome" name="nome" value="<%= cliente.nome %>" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="cpf" class="form-label">CPF*</label>
                    <input type="text" class="form-control" id="cpf" name="cpf" value="<%= cliente.cpf %>" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="nome_mae" class="form-label">Nome da Mãe</label>
                    <input type="text" class="form-control" id="nome_mae" name="nome_mae" value="<%= cliente.nome_mae || '' %>">
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="data_nascimento" class="form-label">Data de Nascimento</label>
                    <input type="date" class="form-control" id="data_nascimento" name="data_nascimento" value="<%= cliente.data_nascimento ? cliente.data_nascimento.toISOString().split('T')[0] : '' %>">
                </div>
                
                <!-- Contato -->
                <div class="col-12 mt-2 mb-3">
                    <h6 class="text-muted">Contato</h6>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="email" class="form-label">Email*</label>
                    <input type="email" class="form-control" id="email" name="email" value="<%= cliente.email %>" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="telefone" class="form-label">Telefone Principal*</label>
                    <input type="text" class="form-control" id="telefone" name="telefone" value="<%= cliente.telefone %>" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="telefone2" class="form-label">Telefone Secundário</label>
                    <input type="text" class="form-control" id="telefone2" name="telefone2" value="<%= cliente.telefone2 || '' %>">
                </div>
                
                <!-- Endereço -->
                <div class="col-12 mt-2 mb-3">
                    <h6 class="text-muted">Endereço</h6>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="cep" class="form-label">CEP</label>
                    <input type="text" class="form-control" id="cep" name="cep" placeholder="00000-000" maxlength="9" value="<%= cliente.cep || '' %>">
                    <small class="text-muted">Digite o CEP para preencher o endereço automaticamente.</small>
                </div>
                
                <div class="col-md-8 mb-3">
                    <label for="logradouro" class="form-label">Logradouro</label>
                    <input type="text" class="form-control" id="logradouro" name="logradouro" value="<%= cliente.logradouro || '' %>">
                </div>
                
                <div class="col-md-2 mb-3">
                    <label for="numero" class="form-label">Número</label>
                    <input type="text" class="form-control" id="numero" name="numero" value="<%= cliente.numero || '' %>">
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="bairro" class="form-label">Bairro</label>
                    <input type="text" class="form-control" id="bairro" name="bairro" value="<%= cliente.bairro || '' %>">
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="cidade" class="form-label">Cidade</label>
                    <input type="text" class="form-control" id="cidade" name="cidade" value="<%= cliente.cidade || '' %>">
                </div>
                
                <!-- Informações do Condomínio -->
                <div class="col-12 mt-2 mb-3">
                    <h6 class="text-muted">Informações do Condomínio</h6>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="condominio_id" class="form-label">Condomínio*</label>
                    <select class="form-select" id="condominio_id" name="condominio_id" required>
                        <option value="">Selecione um condomínio</option>
                        <% if (condominios && condominios.length > 0) { %>
                            <% condominios.forEach(condominio => { %>
                                <option value="<%= condominio.id %>" <%= cliente.condominio_id === condominio.id ? 'selected' : '' %>><%= condominio.nome %></option>
                            <% }); %>
                        <% } %>
                    </select>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="bloco" class="form-label">Bloco*</label>
                    <input type="text" class="form-control" id="bloco" name="bloco" value="<%= cliente.bloco %>" required>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="apartamento" class="form-label">Apartamento*</label>
                    <input type="text" class="form-control" id="apartamento" name="apartamento" value="<%= cliente.apartamento %>" required>
                </div>
                
                <!-- Informações do Plano -->
                <div class="col-12 mt-2 mb-3">
                    <h6 class="text-muted">Informações do Plano</h6>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="plano_contratado" class="form-label">Plano Contratado</label>
                    <input type="text" class="form-control" id="plano_contratado" name="plano_contratado" value="<%= cliente.plano_contratado || '' %>">
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="valor" class="form-label">Valor</label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="text" class="form-control" id="valor" name="valor" value="<%= cliente.valor || '' %>">
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="consultor" class="form-label">Consultor</label>
                    <input type="text" class="form-control" id="consultor" name="consultor" value="<%= cliente.consultor || '' %>">
                </div>
                
                <!-- Status -->
                <div class="col-md-12 mb-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="Ativo" <%= cliente.status === 'Ativo' ? 'selected' : '' %>>Ativo</option>
                        <option value="Inativo" <%= cliente.status === 'Inativo' ? 'selected' : '' %>>Inativo</option>
                    </select>
                </div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="/clientes" class="btn btn-outline-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Atualizar</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Scripts para formatação e funcionalidades do formulário
    document.addEventListener('DOMContentLoaded', function() {
        // Formatar CPF
        const cpfInput = document.getElementById('cpf');
        if (cpfInput) {
            cpfInput.addEventListener('input', function() {
                let value = this.value.replace(/\D/g, ''); // Remove caracteres não numéricos
                if (value.length > 11) value = value.slice(0, 11); // Limita a 11 dígitos
                
                // Formata como ###.###.###-##
                if (value.length > 9) {
                    this.value = `${value.slice(0, 3)}.${value.slice(3, 6)}.${value.slice(6, 9)}-${value.slice(9)}`;
                } else if (value.length > 6) {
                    this.value = `${value.slice(0, 3)}.${value.slice(3, 6)}.${value.slice(6)}`;
                } else if (value.length > 3) {
                    this.value = `${value.slice(0, 3)}.${value.slice(3)}`;
                } else {
                    this.value = value;
                }
            });
        }
        
        // Formatar telefones
        const telefoneInputs = [
            document.getElementById('telefone'),
            document.getElementById('telefone2')
        ];
        
        telefoneInputs.forEach(input => {
            if (input) {
                input.addEventListener('input', function() {
                    let value = this.value.replace(/\D/g, '');
                    if (value.length > 11) value = value.slice(0, 11);
                    
                    // Formatar como (##) #####-#### ou (##) ####-####
                    if (value.length > 10) { // Celular com 11 dígitos
                        this.value = `(${value.slice(0, 2)}) ${value.slice(2, 7)}-${value.slice(7)}`;
                    } else if (value.length > 6) { // Telefone fixo com 10 dígitos
                        this.value = `(${value.slice(0, 2)}) ${value.slice(2, 6)}-${value.slice(6)}`;
                    } else if (value.length > 2) { // Apenas DDD
                        this.value = `(${value.slice(0, 2)}) ${value.slice(2)}`;
                    } else {
                        this.value = value;
                    }
                });
            }
        });
        
        // Formatar campo de valor
        const valorInput = document.getElementById('valor');
        if (valorInput) {
            valorInput.addEventListener('input', function() {
                let value = this.value.replace(/\D/g, '');
                value = (parseInt(value) / 100).toFixed(2);
                this.value = value;
            });
        }
        
        // Script CEP integrado
        const cepInput = document.getElementById('cep');
        
        if (!cepInput) {
            console.error('Campo CEP não encontrado!');
            return;
        }
        
        console.log('Campo CEP encontrado na edição');
        
        // Adicionar evento ao perder o foco
        cepInput.addEventListener('blur', function() {
            // Obter o valor do CEP (apenas números)
            const cep = this.value.replace(/\D/g, '');
            
            if (cep.length !== 8) {
                console.log('CEP inválido, precisa ter 8 dígitos');
                return;
            }
            
            console.log('Consultando CEP:', cep);
            
            // Consultar a API
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Resposta da API:', data);
                    
                    // Verificar se o CEP foi encontrado
                    if (data.erro) {
                        console.error('CEP não encontrado na API');
                        return;
                    }
                    
                    // Preencher os campos
                    const logradouroField = document.getElementById('logradouro');
                    const bairroField = document.getElementById('bairro');
                    const cidadeField = document.getElementById('cidade');
                    
                    // Registrar quais campos foram encontrados
                    console.log('Campos encontrados:', {
                        logradouro: !!logradouroField,
                        bairro: !!bairroField,
                        cidade: !!cidadeField
                    });
                    
                    // Preencher os campos se eles existirem
                    if (logradouroField) {
                        logradouroField.value = data.logradouro || '';
                        console.log('Preenchido logradouro:', data.logradouro);
                    }
                    
                    if (bairroField) {
                        bairroField.value = data.bairro || '';
                        console.log('Preenchido bairro:', data.bairro);
                    }
                    
                    if (cidadeField) {
                        cidadeField.value = data.localidade || '';
                        console.log('Preenchido cidade:', data.localidade);
                    }
                })
                .catch(error => {
                    console.error('Erro ao consultar CEP:', error);
                });
        });
        
        // Adicionar formatação ao campo CEP
        cepInput.addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 8) value = value.slice(0, 8);
            
            if (value.length > 5) {
                this.value = `${value.slice(0, 5)}-${value.slice(5)}`;
                console.log('Formatando CEP na edição:', this.value);
            } else {
                this.value = value;
            }
        });
    });
</script>